<% content_for :for_head do %>
  <title>Performance Data</title>	
<% end %>
<script>
$(document).ready(function(){
    $.ajaxSetup({ cache: false });

    // Dropdown menu control
 $(document).on('click', '.dx-toggle', function(){
	if ($(this).children('span').hasClass('glyphicon-menu-right')) {
       	 	$(this).children('span').removeClass('glyphicon-menu-right');
       		$(this).children('span').addClass('glyphicon-menu-down');
    	}
	else {
       	 	$(this).children('span').removeClass('glyphicon-menu-down');
       		$(this).children('span').addClass('glyphicon-menu-right');
	}
	if ($(this).next().hasClass('subdata')) {
        	$(this).next().slideToggle();
	}
	else {
		var level = $(this).attr("id");
        	// Get data from model
		$.ajax({
  			type:"GET",
  			url:"data",
  			dataType:"html",
  			data: {l: level},
  			success: function(data){
    				$("#" + level).after(data);
  			}
		});
	}
    }); 

    // Control progress bars for diagnoses
    $(document).on('mouseover', '.endDx', function(){
           		$(this).next().stop().slideDown();

    });
    $(document).on('mouseout', '.endDx', function(){
    	$(this).next().stop().slideUp();
    });

    // Adding diagnoses to review list
    $(document).on('click', '.add', function(){
		var id = $(this).attr("id");
		var $this = $(this)
        	// Get data from model
		$.ajax({
  			type:"GET",
  			url:"add",
  			dataType:"html",
  			data: {c: id},
  			success: function(data) {
				$this.removeClass('add');
				$this.addClass('remove');
				$this.html(data);
			}
		});

    }); 

    // Removing diagnoses from review list
    $(document).on('click', '.remove', function(){
		var id = $(this).attr("id");
		var $this = $(this)
        	// Get data from model
		$.ajax({
  			type:"GET",
  			url:"remove",
  			dataType:"html",
  			data: {c: id},
  			success: function(data) {
				$this.removeClass('remove');
				$this.addClass('add');
				$this.html(data);
			}
		});

    }); 
});
</script>
<a href="top"></a>
<div class="row container" style="max-width: 600px; margin: 0 auto">

  <%= render "nav" %>
  <div class="col-md-12" style="padding-top: 10px">
  <b>Key:</b>
  <%= image_tag("grey.gif", width: "15px", height: "15px") %> No cases attempted yet 
  <span width="20"></span>
  <%= image_tag("green.gif", width: "15px", height: "15px") %> Excellent 
  <span width="20"></span>
  <%= image_tag("yellow.gif", width: "15px", height: "15px") %> Good 
  <span width="20"></span>
  <%= image_tag("red.gif", width: "15px", height: "15px") %> Needs more work
</div>

  <div style="margin-top: 10px">
<span class="glyphicon glyphicon-list-alt" style="color: green"></span> Diagnosis in review list 
<span class="glyphicon glyphicon-list-alt" style="color: gray"></span> Diagnosis not in review list 
<div class="well well-sm" style="margin-top: 10px">
<i>Clicking on the <u>review list icon</u> <span class="glyphicon glyphicon-list-alt"></span> next to a diagnosis will change its status in your <%= link_to "review list", review_list_problems_path %>- if it is currently in your review list it will be removed, and if it is not in your review list it will be added.</i>
</div>
  </div>

  <% @dxlevel1s.each do |d1| %>
    <!-- Check if there are relevant diagnoses in that category- breast category will not be displayed if only key diagnoses are counted -->
    <% params[:l1_name] = d1.name %>
    <% params[:year_level] = current_user.year_of_training %>
    <% @enddx = EndDx.dxable_search2a(params[:l1_name], params[:year_level]) %>

    <% if @enddx.present? %>  
      <table class="table" style="max-width: 600px; text-align: left; margin: 0 auto">
        <tr>
          <td>
            <% @excellent = 0 %>
            <% @good = 0 %>
            <% @total = 0 %>

            <!-- Calculate performance in that category -->
            <% @enddx.each do |e| %>
              <% @ldx = LearnerDx.where(:end_dx_id => e.id, :user_id => current_user.id).first %>

              <% if @ldx.present? %>
                <% @excellent += @ldx.excellent_cases %>
                <% @good += @ldx.excellent_cases %>
                <% @good += @ldx.correct_dx %>
	        <% @total += @ldx.cases_attempted %>
              <% end %>
            <% end %>

            <!-- Assign appropriate colour box -->
            <% if @total == 0 %>
              <%= image_tag("grey.gif", width: "15px", height: "15px") %> 
            <% else %>
              <% @good = @good/@total*1.00 %>
              <% @excellent = @excellent/@total*1.00 %>

              <% if @excellent > 0.5 %>
                <%= image_tag("green.gif", width: "15px", height: "15px") %>  
              <% elsif @good > 0.5 %>
                <%= image_tag("yellow.gif", width: "15px", height: "15px") %> 
              <% else %>
                <%= image_tag("red.gif", width: "15px", height: "15px") %> 
              <% end %>
            <% end %>

            <!-- Dropdown link -->
            <% @id = "l1_" + d1.id.to_s %>
            <%= content_tag :span, id: @id, class: "dx-toggle" do-%>
              <%= d1.name %>  <%= content_tag :span, "", class: "glyphicon glyphicon-menu-right" %>
            <% end %>
          </td>
        </tr>
      </table>
    <% end %>
  <% end %>

  <p></p>
  <a href="#top">Back to top</a>
</div>
<p></p>
